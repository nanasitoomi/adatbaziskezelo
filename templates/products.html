{% extends 'base.html' %}

{% block title %}Heinemann Termékadatbázis - Termékek{% endblock %}

{% block head %}
<style>
    .hover-shadow {
        transition: all 0.2s ease;
        border: 1px solid #eee;
    }

    .hover-shadow:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #ddd;
        background-color: #f9f9f9;
    }

    .product-card {
        margin-bottom: 0.5rem;
    }

    .list-view .product-card {
        padding: 0.5rem;
    }

    .product-details p {
        margin-bottom: 0.25rem !important;
        line-height: 1.3;
    }

    /* Lista nézet stílusa */
    .list-card .product-details {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem;
    }

    .list-card .product-details p {
        margin: 0 !important;
        padding-right: 0.5rem;
        border-right: 1px solid #ddd;
    }

    .list-card .product-details p:last-child {
        border-right: none;
    }

    /* Színek módosítása */
    a.text-decoration-none {
        color: #333 !important;
    }

    .card-title {
        color: #333 !important;
    }

    .text-muted {
        color: #666 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1>Termékek böngészése</h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Szűrés</h5>
            </div>
            <div class="card-body">
                <form id="filterForm" action="/products" method="get" class="row g-3">
                    <!-- Keresés mező az első helyen -->
                    <div class="col-md-12 mb-4">
                        <label for="search" class="form-label"><i class="bi bi-search"></i> Keresés</label>
                        <input type="text" name="search" id="search" class="form-control form-control-lg" placeholder="Keresés termék neve, márka vagy leírás alapján..." value="{{ search }}">
                    </div>

                    <!-- Alkoholtartalom szűrő -->
                    <div class="col-md-6">
                        <label for="alcohol_range" class="form-label"><i class="bi bi-percent"></i> Alkoholtartalom (%)</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">Min</span>
                                    <input type="number" class="form-control" name="min_alcohol" id="min_alcohol" value="{{ selected_min_alcohol }}" min="0" max="100" step="0.1">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">Max</span>
                                    <input type="number" class="form-control" name="max_alcohol" id="max_alcohol" value="{{ selected_max_alcohol }}" min="0" max="100" step="0.1">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm alcohol-preset" data-min="0" data-max="5">0-5%</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm alcohol-preset" data-min="5" data-max="10">5-10%</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm alcohol-preset" data-min="10" data-max="20">10-20%</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm alcohol-preset" data-min="20" data-max="40">20-40%</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm alcohol-preset" data-min="40" data-max="100">40%+</button>
                            </div>
                        </div>
                    </div>

                    <!-- Kategória szűrő -->
                    <div class="col-md-3">
                        <label for="product_type" class="form-label"><i class="bi bi-tag"></i> Kategória</label>
                        <select name="product_type" id="product_type" class="form-select">
                            <option value="">Minden kategória</option>
                            {% for type in product_types %}
                            <option value="{{ type.product_type }}" {% if selected_product_type == type.product_type %}selected{% endif %}>
                                {{ type.product_type }} ({{ type.count }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Márka szűrő -->
                    <div class="col-md-3">
                        <label for="brand" class="form-label"><i class="bi bi-award"></i> Márka</label>
                        <select name="brand" id="brand" class="form-select">
                            <option value="">Összes márka</option>
                            {% for brand in brands %}
                            <option value="{{ brand.brand }}" {% if selected_brand == brand.brand %}selected{% endif %}>
                                {{ brand.brand }} ({{ brand.count }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Származási hely szűrő -->
                    <div class="col-md-3">
                        <label for="origin" class="form-label"><i class="bi bi-globe"></i> Származási hely</label>
                        <select name="origin" id="origin" class="form-select">
                            <option value="">Összes származási hely</option>
                            {% for origin in origins %}
                            <option value="{{ origin.origin }}" {% if selected_origin == origin.origin %}selected{% endif %}>
                                {{ origin.origin }} ({{ origin.count }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Évjárat szűrő -->
                    <div class="col-md-3">
                        <label for="vintage" class="form-label"><i class="bi bi-calendar-event"></i> Évjárat</label>
                        <select name="vintage" id="vintage" class="form-select">
                            <option value="">Minden évjárat</option>
                            {% for v in vintages %}
                            {% if v.vintage %}
                            <option value="{{ v.vintage }}" {% if selected_vintage == v.vintage %}selected{% endif %}>
                                {{ v.vintage }} ({{ v.count }})
                            </option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Ízjegyek szűrő -->
                    <div class="col-md-3">
                        <label for="taste" class="form-label"><i class="bi bi-cup-hot"></i> Ízjegyek</label>
                        <select name="taste" id="taste" class="form-select">
                            <option value="">Minden ízjegy</option>
                            {% for t in tastes %}
                            {% if t.taste_notes %}
                            <option value="{{ t.taste_notes }}" {% if selected_taste == t.taste_notes %}selected{% endif %}>
                                {{ t.taste_notes }} ({{ t.count }})
                            </option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Kiszerelés szűrő -->
                    <div class="col-md-3">
                        <label for="volume" class="form-label"><i class="bi bi-cup"></i> Kiszerelés</label>
                        <select name="volume" id="volume" class="form-select">
                            <option value="">Minden kiszerelés</option>
                            {% for v in volumes %}
                            <option value="{{ v.volume }}" {% if selected_volume == v.volume %}selected{% endif %}>
                                {{ v.volume }} ({{ v.count }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Admin kategória szűrő -->
                    <div class="col-md-3">
                        <label for="category" class="form-label"><i class="bi bi-gear"></i> Shopify admin kategória <small class="text-muted">(ez nem látható, csak feladatokhoz használt)</small></label>
                        <select name="category" id="category" class="form-select">
                            <option value="">Összes admin kategória</option>
                            {% for category in categories %}
                            <option value="{{ category.category_name }}" {% if selected_category == category.category_name %}selected{% endif %}>
                                {{ category.category_name }} ({{ category.count }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Érlelési mód szűrő -->
                    <div class="col-md-3">
                        <label for="aging_method" class="form-label"><i class="bi bi-hourglass-split"></i> Érlelési mód</label>
                        <select name="aging_method" id="aging_method" class="form-select">
                            <option value="">Összes érlelési mód</option>
                            {% if aging_methods %}
                                {% for method in aging_methods %}
                                <option value="{{ method.aging_method }}" {% if selected_aging_method == method.aging_method %}selected{% endif %}>
                                    {{ method.aging_method }} ({{ method.count }})
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>

                    <!-- Szőlőfajta szűrő -->
                    <div class="col-md-3">
                        <label for="grape_variety" class="form-label"><i class="bi bi-flower1"></i> Szőlőfajta</label>
                        <select name="grape_variety" id="grape_variety" class="form-select">
                            <option value="">Összes szőlőfajta</option>
                            {% if grape_varieties %}
                                {% for grape in grape_varieties %}
                                <option value="{{ grape.grape_variety }}" {% if selected_grape_variety == grape.grape_variety %}selected{% endif %}>
                                    {{ grape.grape_variety }} ({{ grape.count }})
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>

                    <div class="col-12 mt-3 d-flex justify-content-between align-items-center">
                        <div>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-funnel-fill"></i> Szűrés</button>
                            <a href="/products" class="btn btn-outline-primary"><i class="bi bi-x-circle"></i> Szűrők törlése</a>
                        </div>

                        <div class="active-filters">
                            {% if selected_product_type %}
                            <span class="badge bg-secondary me-1">
                                Terméktípus: {{ selected_product_type }}
                                <a href="{{ request.path }}?{% for key, value in request.args.items() %}{% if key != 'product_type' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="text-white ms-1"><i class="bi bi-x"></i></a>
                            </span>
                            {% endif %}

                            {% if selected_brand %}
                            <span class="badge bg-secondary me-1">
                                Márka: {{ selected_brand }}
                                <a href="{{ request.path }}?{% for key, value in request.args.items() %}{% if key != 'brand' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="text-white ms-1"><i class="bi bi-x"></i></a>
                            </span>
                            {% endif %}

                            {% if selected_origin %}
                            <span class="badge bg-secondary me-1">
                                Származás: {{ selected_origin }}
                                <a href="{{ request.path }}?{% for key, value in request.args.items() %}{% if key != 'origin' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="text-white ms-1"><i class="bi bi-x"></i></a>
                            </span>
                            {% endif %}

                            {% if selected_vintage %}
                            <span class="badge bg-secondary me-1">
                                Évjárat: {{ selected_vintage }}
                                <a href="{{ request.path }}?{% for key, value in request.args.items() %}{% if key != 'vintage' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="text-white ms-1"><i class="bi bi-x"></i></a>
                            </span>
                            {% endif %}

                            {% if selected_taste %}
                            <span class="badge bg-secondary me-1">
                                Ízjegy: {{ selected_taste }}
                                <a href="{{ request.path }}?{% for key, value in request.args.items() %}{% if key != 'taste' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="text-white ms-1"><i class="bi bi-x"></i></a>
                            </span>
                            {% endif %}

                            {% if selected_volume %}
                            <span class="badge bg-secondary me-1">
                                Kiszerelés: {{ selected_volume }}
                                <a href="{{ request.path }}?{% for key, value in request.args.items() %}{% if key != 'volume' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="text-white ms-1"><i class="bi bi-x"></i></a>
                            </span>
                            {% endif %}

                            {% if selected_category %}
                            <span class="badge bg-secondary me-1">
                                Admin kategória: {{ selected_category }}
                                <a href="{{ request.path }}?{% for key, value in request.args.items() %}{% if key != 'category' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="text-white ms-1"><i class="bi bi-x"></i></a>
                            </span>
                            {% endif %}

                            {% if search %}
                            <span class="badge bg-secondary me-1">
                                Keresés: {{ search }}
                                <a href="{{ request.path }}?{% for key, value in request.args.items() %}{% if key != 'search' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="text-white ms-1"><i class="bi bi-x"></i></a>
                            </span>
                            {% endif %}

                            {% if selected_min_alcohol != '0.0' or selected_max_alcohol != '100.0' %}
                            <span class="badge bg-secondary me-1">
                                Alkohol: {{ selected_min_alcohol }}% - {{ selected_max_alcohol }}%
                                <a href="{{ request.path }}?{% for key, value in request.args.items() %}{% if key != 'min_alcohol' and key != 'max_alcohol' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="text-white ms-1"><i class="bi bi-x"></i></a>
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12 d-flex justify-content-end">
        <div class="btn-group" role="group" aria-label="Nézet váltás">
            <button type="button" class="btn btn-outline-secondary active" id="gridViewBtn"><i class="bi bi-grid-3x3-gap-fill"></i> Kártyás nézet</button>
            <button type="button" class="btn btn-outline-secondary" id="listViewBtn"><i class="bi bi-list-ul"></i> Lista nézet</button>
        </div>
    </div>
</div>

<div class="row" id="productsContainer">
    {% if products|length > 0 %}
        {% for product in products %}
        <div class="col-md-3 mb-2">
            <a href="/product/{{ product.id }}" class="text-decoration-none">
                <div class="card product-card h-100 border-light hover-shadow">
                    <div class="card-body py-2">
                        <h6 class="card-title mb-1">{{ product.title }}</h6>
                        <p class="card-text text-muted mb-1"><small>{{ product.brand }}</small></p>
                        <hr class="my-1">
                        <div class="product-details small">
                            {% if product.sku %}
                            <p class="mb-1"><span class="text-muted">SKU:</span> {{ product.sku }}</p>
                            {% endif %}
                            {% if product.product_type %}
                            <p class="mb-1"><span class="text-muted">Kategória:</span> {{ product.product_type }}</p>
                            {% endif %}
                            {% if product.origin %}
                            <p class="mb-1"><span class="text-muted">Származás:</span> {{ product.origin }}</p>
                            {% endif %}
                            {% if product.alcohol_content %}
                            <p class="mb-1"><span class="text-muted">Alkohol:</span> {{ product.alcohol_content }}%</p>
                            {% endif %}
                            {% if product.volume %}
                            <p class="mb-1"><span class="text-muted">Kiszerelés:</span> {{ product.volume }}</p>
                            {% endif %}
                            {% if product.vintage %}
                            <p class="mb-1"><span class="text-muted">Évjárat:</span> {{ product.vintage }}</p>
                            {% endif %}
                            {% if product.taste_notes %}
                            <p class="mb-1"><span class="text-muted">Ízjegyek:</span> {{ product.taste_notes }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-md-12">
            <div class="alert alert-light border">
                Nincs találat a megadott szűrési feltételeknek megfelelően.
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Alkohol szűrő preset gombok
        const alcoholPresetButtons = document.querySelectorAll('.alcohol-preset');
        const minAlcoholInput = document.getElementById('min_alcohol');
        const maxAlcoholInput = document.getElementById('max_alcohol');

        alcoholPresetButtons.forEach(button => {
            button.addEventListener('click', function() {
                const min = this.getAttribute('data-min');
                const max = this.getAttribute('data-max');

                minAlcoholInput.value = min;
                maxAlcoholInput.value = max;

                // Aktív állapot beállítása
                alcoholPresetButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                // Form automatikus elküldése
                document.querySelector('form').submit();
            });
        });

        // Nézet váltás beállítása
        setupViewToggle();
    });

    function setupViewToggle() {
        const gridViewBtn = document.getElementById('gridViewBtn');
        const listViewBtn = document.getElementById('listViewBtn');
        const productsContainer = document.getElementById('productsContainer');

        // Mentés a localStorage-ba
        const saveViewPreference = (view) => {
            localStorage.setItem('productViewPreference', view);
        };

        // Kártyás nézet
        gridViewBtn.addEventListener('click', function() {
            gridViewBtn.classList.add('active');
            listViewBtn.classList.remove('active');
            productsContainer.classList.remove('list-view');
            saveViewPreference('grid');
            applyGridView();
        });

        // Lista nézet
        listViewBtn.addEventListener('click', function() {
            listViewBtn.classList.add('active');
            gridViewBtn.classList.remove('active');
            productsContainer.classList.add('list-view');
            saveViewPreference('list');
            applyListView();
        });

        // Korábbi preferencia betöltése
        const viewPreference = localStorage.getItem('productViewPreference');
        if (viewPreference === 'list') {
            listViewBtn.click();
        } else {
            // Alapértelmezett: kártyás nézet
            gridViewBtn.click();
        }
    }

    function applyGridView() {
        const productCards = document.querySelectorAll('.product-card');
        productCards.forEach(card => {
            card.closest('.col-md-3, .col-12').className = 'col-md-3 mb-2';
            card.classList.remove('list-card');

            const cardBody = card.querySelector('.card-body');
            if (cardBody) {
                cardBody.classList.add('py-2');
            }
        });
    }

    function applyListView() {
        const productCards = document.querySelectorAll('.product-card');
        productCards.forEach(card => {
            const col = card.closest('.col-md-3, .col-12');
            col.className = 'col-12 mb-2';

            // Átalakítás lista nézetre
            card.classList.add('list-card');

            const cardBody = card.querySelector('.card-body');
            if (cardBody) {
                cardBody.classList.add('py-2');
            }
        });
    }
</script>
{% endblock %}
